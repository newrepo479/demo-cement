<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nowe zamówienie - SOHOsoft Portal</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-black': '#000',
                        'custom-white': '#fff',
                        'custom-gray': '#ccc',
                        'custom-action': '#ef7d05'
                    }
                }
            }
        }
    </script>
    <!-- Flaticon -->
    <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/2.1.0/uicons-regular-rounded/css/uicons-regular-rounded.css">
    <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/2.1.0/uicons-bold-rounded/css/uicons-bold-rounded.css">
    <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/2.1.0/uicons-solid-rounded/css/uicons-solid-rounded.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --color-black: #000;
            --color-white: #fff;
            --color-gray: #ccc;
            --color-action: #ef7d05;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--color-white);
            color: var(--color-black);
            min-height: 100vh;
        }

        .wizard-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .wizard-header {
            background: var(--color-white);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid var(--color-gray);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .wizard-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--color-black);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .close-btn {
            background: var(--color-gray);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: var(--color-action);
            color: var(--color-white);
        }

        .progress-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-step {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--color-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            color: var(--color-black);
            margin-bottom: 8px;
            transition: all 0.3s;
            z-index: 2;
        }

        .step-circle.active {
            background: var(--color-action);
            color: var(--color-white);
            transform: scale(1.1);
        }

        .step-circle.completed {
            background: var(--color-black);
            color: var(--color-white);
        }

        .step-label {
            font-size: 13px;
            color: var(--color-gray);
            text-align: center;
        }

        .step-label.active {
            color: var(--color-action);
            font-weight: 600;
        }

        .progress-line {
            position: absolute;
            top: 20px;
            left: 50%;
            right: -50%;
            height: 3px;
            background: var(--color-gray);
            z-index: 1;
        }

        .progress-line.completed {
            background: var(--color-action);
        }

        .wizard-content {
            background: var(--color-white);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            min-height: 500px;
            border: 1px solid var(--color-gray);
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-black);
            margin-bottom: 8px;
        }

        .step-subtitle {
            font-size: 14px;
            color: var(--color-gray);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--color-black);
            margin-bottom: 8px;
        }

        .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--color-gray);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            cursor: pointer;
            background: var(--color-white);
        }

        .form-select:focus {
            outline: none;
            border-color: var(--color-action);
            box-shadow: 0 0 0 4px rgba(239, 125, 5, 0.1);
        }

        .location-card {
            border: 2px solid var(--color-gray);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .location-card:hover {
            border-color: var(--color-action);
            background: var(--color-white);
        }

        .location-card.selected {
            border-color: var(--color-action);
            background: rgba(239, 125, 5, 0.05);
        }

        .location-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-black);
            margin-bottom: 6px;
        }

        .location-address {
            font-size: 14px;
            color: var(--color-gray);
            margin-bottom: 8px;
        }

        .location-products {
            font-size: 13px;
            color: var(--color-action);
        }

        .btn-add {
            width: 100%;
            padding: 14px;
            border: 2px dashed var(--color-gray);
            background: var(--color-white);
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            color: var(--color-action);
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-add:hover {
            border-color: var(--color-action);
            background: var(--color-white);
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .product-card {
            border: 3px solid var(--color-gray);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .product-card:hover {
            border-color: var(--color-action);
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .product-card.selected {
            border-color: var(--color-action);
            background: rgba(239, 125, 5, 0.05);
        }

        .product-card.selected::after {
            content: '✓';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            background: var(--color-action);
            color: var(--color-white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .product-image {
            width: 100%;
            height: 120px;
            background: var(--color-black);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .product-image i {
            font-size: 48px;
            color: var(--color-white);
        }

        .product-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-black);
            margin-bottom: 8px;
        }

        .product-price {
            font-size: 20px;
            font-weight: 700;
            color: var(--color-action);
            margin-bottom: 4px;
        }

        .product-unit {
            font-size: 12px;
            color: var(--color-gray);
        }

        .suggest-section {
            background: var(--color-gray);
            border-radius: 12px;
            padding: 24px;
            margin-top: 30px;
        }

        .suggest-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-black);
            margin-bottom: 16px;
        }

        .suggest-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .suggest-card {
            background: var(--color-white);
            border: 2px solid var(--color-gray);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
        }

        .suggest-card .product-name {
            font-size: 14px;
        }

        .suggest-card .product-price {
            font-size: 16px;
        }

        .quantity-section {
            background: var(--color-white);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 2px solid var(--color-action);
        }

        .radio-group {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }

        .radio-option {
            flex: 1;
            position: relative;
        }

        .radio-option input {
            position: absolute;
            opacity: 0;
        }

        .radio-label {
            display: block;
            padding: 12px 20px;
            border: 2px solid var(--color-gray);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .radio-option input:checked + .radio-label {
            border-color: var(--color-action);
            background: rgba(239, 125, 5, 0.1);
            color: var(--color-action);
        }

        .quantity-input-group {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .quantity-input {
            flex: 1;
            padding: 14px 16px;
            border: 2px solid var(--color-gray);
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
        }

        .quantity-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--color-gray);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            margin: 16px 0;
            cursor: pointer;
        }

        .quantity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--color-action);
            cursor: pointer;
            border: 3px solid var(--color-white);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }

        .quantity-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(239, 125, 5, 0.4);
        }

        .quantity-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--color-action);
            cursor: pointer;
            border: 3px solid var(--color-white);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }

        .quantity-slider::-moz-range-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(239, 125, 5, 0.4);
        }

        .quantity-slider::-moz-range-track {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--color-gray);
        }

        .quantity-slider:focus {
            outline: none;
        }

        .quantity-slider:focus::-webkit-slider-thumb {
            box-shadow: 0 0 0 4px rgba(239, 125, 5, 0.2);
        }

        .quantity-slider:focus::-moz-range-thumb {
            box-shadow: 0 0 0 4px rgba(239, 125, 5, 0.2);
        }

        .quantity-hint {
            font-size: 14px;
            color: var(--color-gray);
            text-align: center;
        }

        .price-summary {
            background: var(--color-black);
            color: var(--color-white);
            border-radius: 12px;
            padding: 24px;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .price-row.total {
            font-size: 24px;
            font-weight: 700;
            padding-top: 16px;
            border-top: 2px solid rgba(255,255,255,0.3);
        }

        .transport-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .transport-card {
            border: 3px solid var(--color-gray);
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .transport-card:hover {
            border-color: var(--color-action);
            transform: translateY(-4px);
        }

        .transport-card.selected {
            border-color: var(--color-action);
            background: rgba(239, 125, 5, 0.05);
        }

        .transport-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--color-action);
        }
        
        .transport-icon i {
            font-size: 48px;
        }

        .transport-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-black);
            margin-bottom: 8px;
        }

        .transport-desc {
            font-size: 13px;
            color: var(--color-gray);
        }

        .date-time-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            background: var(--color-white);
            border: 2px solid var(--color-action);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--color-gray);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--color-action);
            box-shadow: 0 0 0 4px rgba(239, 125, 5, 0.1);
        }

        .form-textarea {
            width: 100%;
            min-height: 100px;
            padding: 14px 16px;
            border: 2px solid var(--color-gray);
            border-radius: 10px;
            font-size: 15px;
            resize: vertical;
            transition: all 0.3s;
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--color-action);
            box-shadow: 0 0 0 4px rgba(239, 125, 5, 0.1);
        }

        .info-box {
            background: rgba(239, 125, 5, 0.1);
            border-left: 4px solid var(--color-action);
            padding: 16px;
            border-radius: 8px;
            font-size: 14px;
            color: var(--color-black);
            line-height: 1.6;
        }

        .summary-box {
            border: 2px solid var(--color-gray);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .summary-section {
            margin-bottom: 24px;
        }

        .summary-section:last-child {
            margin-bottom: 0;
        }

        .summary-label {
            font-size: 13px;
            color: var(--color-gray);
            margin-bottom: 4px;
        }

        .summary-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-black);
        }

        .checkbox-group {
            margin: 24px 0;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: var(--color-black);
            cursor: pointer;
            margin-bottom: 12px;
        }

        .checkbox-label input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .wizard-actions {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            margin-top: 40px;
            padding-top: 24px;
            border-top: 2px solid var(--color-gray);
        }

        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary {
            background: var(--color-gray);
            color: var(--color-black);
        }

        .btn-secondary:hover {
            background: var(--color-gray);
        }

        .btn-primary {
            background: var(--color-action);
            color: var(--color-white);
        }

        .btn-primary:hover {
            background: #d66a04;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(239, 125, 5, 0.3);
        }

        .btn-success {
            background: var(--color-action);
            color: var(--color-white);
        }

        .btn-success:hover {
            background: #d66a04;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--color-white);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            border: 1px solid var(--color-gray);
        }

        .success-icon {
            font-size: 72px;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--color-black);
            margin-bottom: 16px;
        }

        .modal-text {
            font-size: 15px;
            color: var(--color-gray);
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .order-number {
            background: var(--color-gray);
            padding: 16px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            color: var(--color-action);
            margin-bottom: 24px;
        }

        .modal-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        @media (max-width: 768px) {
            .wizard-container {
                padding: 20px 10px;
            }

            .wizard-header {
                padding: 20px;
            }

            .wizard-content {
                padding: 24px;
            }

            .progress-bar {
                overflow-x: auto;
            }

            .products-grid {
                grid-template-columns: 1fr;
            }

            .transport-options {
                grid-template-columns: 1fr;
            }

            .date-time-grid {
                grid-template-columns: 1fr;
            }

            .wizard-actions {
                flex-direction: column;
            }

            .modal-actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="wizard-container">
        <!-- Wizard Header -->
        <div class="wizard-header">
            <div class="header-top">
                <h1 class="wizard-title">
                    <i class="fi fi-rr-shopping-cart"></i> Nowe zamówienie
                </h1>
                <button class="close-btn" onclick="window.location.href='dashboard-klient.html'">×</button>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-step">
                    <div class="step-circle active" id="circle-1">1</div>
                    <div class="step-label active">Dostawa</div>
                    <div class="progress-line" id="line-1"></div>
                </div>
                <div class="progress-step">
                    <div class="step-circle" id="circle-2">2</div>
                    <div class="step-label">Produkt</div>
                    <div class="progress-line" id="line-2"></div>
                </div>
                <div class="progress-step">
                    <div class="step-circle" id="circle-3">3</div>
                    <div class="step-label">Transport</div>
                    <div class="progress-line" id="line-3"></div>
                </div>
                <div class="progress-step">
                    <div class="step-circle" id="circle-4">4</div>
                    <div class="step-label">Podsumowanie</div>
                </div>
            </div>
        </div>

        <!-- Wizard Content -->
        <div class="wizard-content">
            <!-- Step 1: Delivery Location -->
            <div class="step-content active" id="step-1">
                <h2 class="step-title"><i class="fi fi-rr-marker"></i> Krok 1: Wybierz miejsce dostawy</h2>
                <p class="step-subtitle">Firma: Przykładowa Firma Budowlana Sp. z o.o.</p>

                <div class="form-group">
                    <label class="form-label">Punkt odbioru:</label>
                    
                    <div class="location-card" onclick="selectLocation(1)">
                        <div class="location-name"><i class="fi fi-rr-marker"></i> Magazyn Centralny</div>
                        <div class="location-address">ul. Przemysłowa 45, 00-001 Warszawa</div>
                        <div class="location-products"><i class="fi fi-rr-settings"></i> Dostępne produkty: CEM I, CEM II (3 produkty)</div>
                    </div>

                    <div class="location-card" onclick="selectLocation(2)">
                        <div class="location-name"><i class="fi fi-rr-marker"></i> Punkt Odbioru Południe</div>
                        <div class="location-address">ul. Budowlana 12, 30-001 Kraków</div>
                        <div class="location-products"><i class="fi fi-rr-settings"></i> Dostępne produkty: CEM I, CEM V (4 produkty)</div>
                    </div>

                    <div class="location-card" onclick="selectLocation(3)">
                        <div class="location-name"><i class="fi fi-rr-marker"></i> Skład Regionalny</div>
                        <div class="location-address">ul. Magazynowa 88, 50-001 Wrocław</div>
                        <div class="location-products"><i class="fi fi-rr-settings"></i> Dostępne produkty: CEM I, CEM II, CEM V (5 produktów)</div>
                    </div>

                    <button class="btn-add" onclick="openAddAddressModal()">+ DODAJ NOWY PUNKT ODBIORU</button>
                </div>
            </div>

            <!-- Step 2: Product Selection -->
            <div class="step-content" id="step-2">
                <h2 class="step-title"><i class="fi fi-rr-shopping-cart"></i> Krok 2: Wybierz produkt i ilość</h2>
                <p class="step-subtitle">Dostawa do: <strong id="selected-location">Magazyn Centralny - ul. Przemysłowa 45, Warszawa</strong></p>

                <div class="form-group">
                    <label class="form-label">Dostępne dla Ciebie produkty:</label>
                    <div class="products-grid">
                        <div class="product-card" onclick="selectProduct(1)">
                            <div class="product-image"><i class="fi fi-rr-building" style="font-size: 48px; color: var(--color-white);"></i></div>
                            <div class="product-name">CEM I 42,5R</div>
                            <div class="product-price">400 PLN</div>
                            <div class="product-unit">/tona netto</div>
                        </div>

                        <div class="product-card selected" onclick="selectProduct(2)">
                            <div class="product-image" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);"><i class="fi fi-rr-building" style="font-size: 48px; color: var(--color-white);"></i></div>
                            <div class="product-name">CEM II/B-S 42,5N</div>
                            <div class="product-price">410 PLN</div>
                            <div class="product-unit">/tona netto</div>
                        </div>

                        <div class="product-card" onclick="selectProduct(3)">
                            <div class="product-image" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);"><i class="fi fi-rr-building" style="font-size: 48px; color: var(--color-white);"></i></div>
                            <div class="product-name">CEM II/A-S 42,5N</div>
                            <div class="product-price">420 PLN</div>
                            <div class="product-unit">/tona netto</div>
                        </div>
                    </div>
                </div>

                <!-- Quantity Selection -->
                <div class="quantity-section">
                    <label class="form-label">Jednostka:</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" name="unit" id="unit-tons" value="tons" onchange="changeUnit('tons')">
                            <label class="radio-label" for="unit-tons">Tony</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" name="unit" id="unit-pallets" value="pallets" checked onchange="changeUnit('pallets')">
                            <label class="radio-label" for="unit-pallets">Palety</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" name="unit" id="unit-trucks" value="trucks" onchange="changeUnit('trucks')">
                            <label class="radio-label" for="unit-trucks">Samochody</label>
                        </div>
                    </div>

                    <label class="form-label" id="quantity-label">Ilość palet:</label>
                    <div class="quantity-input-group">
                        <input type="number" class="quantity-input" id="quantity" value="17" min="1" max="40" oninput="updateQuantity()">
                    </div>
                    <input type="range" class="quantity-slider" id="quantity-slider" value="17" min="1" max="40" oninput="updateQuantityFromSlider()">
                    <p class="quantity-hint" id="quantity-conversion"><i class="fi fi-rr-lightbulb"></i> 17 palet ≈ 24.8 tony</p>
                </div>

                <!-- Price Summary -->
                <div class="price-summary">
                    <div class="price-row">
                        <span>Wartość netto:</span>
                        <span id="price-net">10,168 PLN</span>
                    </div>
                    <div class="price-row">
                        <span>VAT 23%:</span>
                        <span id="price-vat">2,339 PLN</span>
                    </div>
                    <div class="price-row total">
                        <span>RAZEM brutto:</span>
                        <span id="price-total">12,507 PLN</span>
                    </div>
                </div>

                <!-- Cross-sell Suggestions -->
                <div class="suggest-section">
                    <div class="suggest-title"><i class="fi fi-rr-sparkles"></i> Możesz być zainteresowany:</div>
                    <div class="suggest-grid">
                        <div class="suggest-card">
                            <div class="product-image" style="height: 80px; font-size: 36px;"><i class="fi fi-rr-droplet" style="font-size: 36px; color: var(--color-white);"></i></div>
                            <div class="product-name">CEM V 32,5N</div>
                            <div class="product-price">480 PLN</div>
                            <div class="product-unit">/tona</div>
                            <button class="btn-add" style="margin-top: 12px; padding: 8px;">Dodaj</button>
                        </div>
                        <div class="suggest-card">
                            <div class="product-image" style="height: 80px; font-size: 36px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"><i class="fi fi-rr-flask" style="font-size: 36px; color: var(--color-white);"></i></div>
                            <div class="product-name">Dodatki do betonu</div>
                            <div class="product-price">85 PLN</div>
                            <div class="product-unit">/worek</div>
                            <button class="btn-add" style="margin-top: 12px; padding: 8px;">Dodaj</button>
                        </div>
                    </div>
                    <p style="font-size: 13px; color: var(--color-gray); text-align: center; margin-top: 16px;">
                        <i class="fi fi-rr-lightbulb"></i> Klienci podobni do Ciebie często kupują razem z CEM II
                    </p>
                </div>
            </div>

            <!-- Step 3: Transport -->
            <div class="step-content" id="step-3">
                <h2 class="step-title"><i class="fi fi-rr-truck"></i> Krok 3: Transport i termin dostawy</h2>
                <p class="step-subtitle">Wybierz sposób dostawy i termin</p>

                <div class="form-group">
                    <label class="form-label">Rodzaj transportu:</label>
                    <div class="transport-options">
                        <div class="transport-card" onclick="selectTransport('own')">
                            <div class="transport-icon"><i class="fi fi-rr-truck-side" style="font-size: 48px;"></i></div>
                            <div class="transport-name">Transport własny</div>
                            <div class="transport-desc">Cena -15%<br>Własny pojazd</div>
                        </div>
                        <div class="transport-card selected" onclick="selectTransport('geo')">
                            <div class="transport-icon"><i class="fi fi-rr-factory" style="font-size: 48px;"></i></div>
                            <div class="transport-name">Transport GEO</div>
                            <div class="transport-desc">Organizujemy dostawę<br>Pełna obsługa</div>
                        </div>
                    </div>
                </div>

                <div class="date-time-grid">
                    <div class="form-group">
                        <label class="form-label" for="delivery-date"><i class="fi fi-rr-calendar"></i> Data dostawy:</label>
                        <input type="date" id="delivery-date" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="delivery-time"><i class="fi fi-rr-clock"></i> Godzina dostawy:</label>
                        <input type="time" id="delivery-time" class="form-input" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="notes"><i class="fi fi-rr-comment"></i> Uwagi dla spedytora (opcjonalnie):</label>
                    <textarea id="notes" class="form-textarea" placeholder="Dodatkowe informacje..."></textarea>
                </div>

                <div class="info-box">
                    <i class="fi fi-rr-exclamation-triangle"></i> <strong>Przypomnienie:</strong> Przy transporcie GEO spedytor otrzyma SMS z PIN-em dla kierowcy po zatwierdzeniu zamówienia.
                </div>
            </div>

            <!-- Step 4: Summary -->
            <div class="step-content" id="step-4">
                <h2 class="step-title"><i class="fi fi-rr-check-circle"></i> Krok 4: Podsumowanie zamówienia</h2>
                <p class="step-subtitle">Sprawdź dane przed zatwierdzeniem</p>

                <div class="summary-box">
                    <div class="summary-section">
                        <div class="summary-label"><i class="fi fi-rr-marker"></i> Dostawa:</div>
                        <div class="summary-value">Magazyn Centralny - ul. Przemysłowa 45, 00-001 Warszawa</div>
                    </div>

                    <div class="summary-section">
                        <div class="summary-label"><i class="fi fi-rr-box"></i> Produkt:</div>
                        <div class="summary-value">CEM II/B-S 42,5N</div>
                        <div class="summary-value" style="font-size: 14px; font-weight: 400; margin-top: 4px;">
                            Ilość: 17 palet (24.8 tony) | Cena: 410 PLN/tona | Wartość: 10,168 PLN netto
                        </div>
                    </div>

                    <div class="summary-section">
                        <div class="summary-label"><i class="fi fi-rr-truck"></i> Transport:</div>
                        <div class="summary-value">Transport GEO (organizowany przez Cementownię)</div>
                        <div class="summary-value" style="font-size: 14px; font-weight: 400; margin-top: 4px;">
                            Data: 12.01.2026, godzina: 12:00
                        </div>
                    </div>

                    <div class="summary-section">
                        <div class="summary-label"><i class="fi fi-rr-comment"></i> Uwagi:</div>
                        <div class="summary-value">Brak uwag</div>
                    </div>
                </div>

                <div class="price-summary" style="margin-bottom: 24px;">
                    <div class="price-row">
                        <span>Wartość netto:</span>
                        <span>10,168.00 PLN</span>
                    </div>
                    <div class="price-row">
                        <span>VAT 23%:</span>
                        <span>2,338.64 PLN</span>
                    </div>
                    <div class="price-row total">
                        <span>RAZEM brutto:</span>
                        <span>12,506.64 PLN</span>
                    </div>
                </div>

                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="terms" required>
                        <span>Akceptuję regulamin zamówień</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="confirm" required>
                        <span>Potwierdzam poprawność danych</span>
                    </label>
                </div>

                <div class="info-box">
                    <i class="fi fi-rr-lightbulb"></i> <strong>Po zatwierdzeniu:</strong><br>
                    • Otrzymasz SMS/email z potwierdzeniem<br>
                    • Spedytor zostanie powiadomiony<br>
                    • Możesz śledzić status w "Moje zamówienia"
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="wizard-actions">
                <button class="btn btn-secondary" id="btn-prev" onclick="prevStep()" style="display: none;">
                    ← Wstecz
                </button>
                <button class="btn btn-primary" id="btn-next" onclick="nextStep()" style="margin-left: auto;">
                    Dalej →
                </button>
            </div>
        </div>
    </div>

    <!-- Add Address Modal -->
    <div class="modal" id="addAddressModal">
        <div class="modal-content" style="max-width: 600px; text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 class="modal-title" style="margin-bottom: 0;"><i class="fi fi-rr-marker"></i> Dodaj nowy punkt odbioru</h2>
                <button class="close-btn" onclick="closeAddAddressModal()" style="width: 32px; height: 32px; font-size: 18px;">×</button>
            </div>
            
            <form id="addAddressForm" onsubmit="saveNewAddress(event)">
                <div class="form-group">
                    <label class="form-label">Nazwa punktu odbioru *</label>
                    <input type="text" class="form-input" id="address-name" placeholder="np. Magazyn Główny" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ulica i numer *</label>
                    <input type="text" class="form-input" id="address-street" placeholder="ul. Przykładowa 123" required>
                </div>
                
                <div class="date-time-grid">
                    <div class="form-group">
                        <label class="form-label">Kod pocztowy *</label>
                        <input type="text" class="form-input" id="address-postal" placeholder="00-000" pattern="[0-9]{2}-[0-9]{3}" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Miasto *</label>
                        <input type="text" class="form-input" id="address-city" placeholder="Warszawa" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Dostępne produkty</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="products" value="CEM I">
                            <span>CEM I</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="products" value="CEM II">
                            <span>CEM II</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="products" value="CEM V">
                            <span>CEM V</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Uwagi (opcjonalnie)</label>
                    <textarea class="form-textarea" id="address-notes" placeholder="Dodatkowe informacje o punkcie odbioru..."></textarea>
                </div>
                
                <div class="wizard-actions" style="margin-top: 24px; padding-top: 0; border-top: none;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddAddressModal()">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Zapisz punkt odbioru</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal" id="successModal">
        <div class="modal-content">
            <div class="success-icon"><i class="fi fi-rr-check-circle" style="font-size: 72px; color: var(--color-action);"></i></div>
            <h2 class="modal-title" id="successModalTitle">Zamówienie złożone!</h2>
            <p class="modal-text" id="successModalText">
                Dziękujemy! Twoje zamówienie zostało pomyślnie przyjęte do realizacji.<br><br>
                <i class="fi fi-rr-envelope"></i> Potwierdzenie wysłane na email<br>
                <i class="fi fi-rr-mobile"></i> SMS wysłany do spedytora
            </p>
            <div class="order-number">Numer zamówienia: #ZAM-2024-1235</div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="window.location.href='dashboard-klient.html'">WRÓĆ DO DASHBOARDU</button>
                <button class="btn btn-primary" onclick="window.location.href='dashboard-klient.html?tab=zamowienia'">ZOBACZ ZAMÓWIENIE</button>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // localStorage Helper Functions
        // =====================================================
        const STORAGE_PREFIX = 'app:shared:';

        function storageGet(key, defaultValue = []) {
            try {
                const data = localStorage.getItem(STORAGE_PREFIX + key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (e) {
                console.error('Error reading from localStorage:', e);
                return defaultValue;
            }
        }

        function storageSet(key, value) {
            try {
                localStorage.setItem(STORAGE_PREFIX + key, JSON.stringify(value));
                return true;
            } catch (e) {
                console.error('Error writing to localStorage:', e);
                return false;
            }
        }

        function generateId() {
            return Date.now() + Math.random();
        }

        function upsertRecord(key, record) {
            const records = storageGet(key, []);
            if (!record.id) {
                record.id = generateId();
            }
            const index = records.findIndex(r => r.id === record.id);
            if (index >= 0) {
                records[index] = record;
            } else {
                records.push(record);
            }
            storageSet(key, records);
            return record;
        }

        function deleteRecord(key, id) {
            const records = storageGet(key, []);
            const filtered = records.filter(r => r.id !== id);
            storageSet(key, filtered);
            return filtered;
        }

        // =====================================================
        // Render Saved Addresses
        // =====================================================
        function renderSavedAddresses() {
            const addresses = storageGet('addresses', []);
            const addButton = document.querySelector('.btn-add');
            if (!addButton) return;

            // Remove previously rendered localStorage addresses
            document.querySelectorAll('.location-card[data-storage-id]').forEach(card => card.remove());

            // Render each saved address
            addresses.forEach(addr => {
                const newCard = document.createElement('div');
                newCard.className = 'location-card';
                newCard.setAttribute('data-storage-id', addr.id);
                newCard.onclick = function(e) {
                    if (!e.target.closest('.delete-address-btn')) {
                        selectLocation(0);
                    }
                };
                newCard.innerHTML = `
                    <div class="location-name"><i class="fi fi-rr-marker"></i> ${addr.name}
                        <button class="delete-address-btn" onclick="deleteAddress(${addr.id})" title="Usuń" style="float: right; background: none; border: none; cursor: pointer; color: var(--color-gray); font-size: 16px;">
                            <i class="fi fi-rr-trash"></i>
                        </button>
                    </div>
                    <div class="location-address">${addr.street}, ${addr.postal} ${addr.city}</div>
                    <div class="location-products"><i class="fi fi-rr-settings"></i> Dostępne produkty: ${addr.productsText || 'Brak produktów'}</div>
                `;
                addButton.parentNode.insertBefore(newCard, addButton);
            });
        }

        function deleteAddress(id) {
            if (confirm('Czy na pewno chcesz usunąć ten punkt odbioru?')) {
                deleteRecord('addresses', id);
                renderSavedAddresses();
            }
        }

        // =====================================================
        // Wizard State
        // =====================================================
        let currentStep = 1;
        const totalSteps = 4;
        let editOrderId = null;
        let editOrderData = null;
        
        // Check for edit mode on page load
        function checkEditMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit');
            
            if (editId) {
                const orders = JSON.parse(localStorage.getItem('app:shared:orders') || '[]');
                const order = orders.find(o => o.id == editId);
                
                if (order) {
                    editOrderId = order.id;
                    editOrderData = order;
                    loadOrderForEdit(order);
                }
            }
        }
        
        function loadOrderForEdit(order) {
            // Update title
            const titleEl = document.querySelector('.wizard-title');
            if (titleEl) {
                titleEl.innerHTML = '<i class="fi fi-rr-edit"></i> Edytuj zamówienie ' + order.number;
            }
            
            // Set product selection
            const productNameToId = {
                'CEM I 42,5R': 1,
                'CEM II/B-S 42,5N': 2,
                'CEM II/A-S 42,5N': 3
            };
            const productId = productNameToId[order.product] || 2;
            
            // Select product card
            document.querySelectorAll('.product-card').forEach((card, index) => {
                if (index + 1 === productId) {
                    card.classList.add('selected');
                    selectedProductId = productId;
                } else {
                    card.classList.remove('selected');
                }
            });
            
            // Set quantity and unit
            if (order.quantity) {
                document.getElementById('quantity').value = order.quantity;
            }
            
            if (order.unit) {
                selectedUnit = order.unit;
                document.querySelectorAll('.unit-btn').forEach(btn => {
                    if (btn.getAttribute('data-unit') === order.unit) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }
            
            // Update calculation
            updateCalculation();
            
            // Set delivery date and time
            if (order.deliveryDate) {
                document.getElementById('delivery-date').value = order.deliveryDate;
            }
            if (order.deliveryTime) {
                document.getElementById('delivery-time').value = order.deliveryTime;
            }
            
            // Set location
            if (order.location) {
                const selectedLocationEl = document.getElementById('selected-location');
                if (selectedLocationEl) {
                    selectedLocationEl.textContent = order.location;
                }
            }
            
            // Set notes
            if (order.notes) {
                const notesEl = document.getElementById('notes');
                if (notesEl) {
                    notesEl.value = order.notes;
                }
            }
            
            // Update button text
            const btnNext = document.getElementById('btnNext');
            // Will be updated in updateStepUI based on step
        }

        function updateStepUI() {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(step => {
                step.classList.remove('active');
            });
            
            // Show current step
            document.getElementById(`step-${currentStep}`).classList.add('active');
            
            // Update circles and labels
            for (let i = 1; i <= totalSteps; i++) {
                const circle = document.getElementById(`circle-${i}`);
                const line = document.getElementById(`line-${i}`);
                
                if (i < currentStep) {
                    circle.classList.add('completed');
                    circle.classList.remove('active');
                    if (line) line.classList.add('completed');
                } else if (i === currentStep) {
                    circle.classList.add('active');
                    circle.classList.remove('completed');
                } else {
                    circle.classList.remove('active', 'completed');
                    if (line) line.classList.remove('completed');
                }
            }
            
            // Update buttons
            const btnPrev = document.getElementById('btn-prev');
            const btnNext = document.getElementById('btn-next');
            
            if (currentStep === 1) {
                btnPrev.style.display = 'none';
                btnNext.style.marginLeft = 'auto';
            } else {
                btnPrev.style.display = 'flex';
                btnNext.style.marginLeft = '0';
            }
            
            if (currentStep === totalSteps) {
                if (editOrderId) {
                    btnNext.innerHTML = '<i class="fi fi-rr-check-circle"></i> ZAPISZ ZMIANY';
                } else {
                    btnNext.innerHTML = '<i class="fi fi-rr-check-circle"></i> ZATWIERDŹ ZAMÓWIENIE';
                }
                btnNext.classList.remove('btn-primary');
                btnNext.classList.add('btn-success');
            } else {
                btnNext.innerHTML = 'Dalej →';
                btnNext.classList.remove('btn-success');
                btnNext.classList.add('btn-primary');
            }
        }

        // =====================================================
        // Save Order to Shared Storage
        // =====================================================
        function saveOrderToStorage() {
            const productNames = {
                1: 'CEM I 42,5R',
                2: 'CEM II/B-S 42,5N',
                3: 'CEM II/A-S 42,5N'
            };
            
            const quantity = parseFloat(document.getElementById('quantity').value) || 0;
            const pricePerTon = productPrices[selectedProductId] || 410;
            
            // Convert to tons for price calculation
            let tons = 0;
            if (selectedUnit === 'tons') {
                tons = quantity;
            } else if (selectedUnit === 'pallets') {
                tons = quantity * CONVERSION_RATES.palletToTon;
            } else if (selectedUnit === 'trucks') {
                tons = quantity * CONVERSION_RATES.truckToTon;
            }
            
            const netPrice = tons * pricePerTon;
            const vat = netPrice * 0.23;
            const total = netPrice + vat;
            
            // Get orders from storage
            const orders = JSON.parse(localStorage.getItem('app:shared:orders') || '[]');
            
            // Check if editing existing order
            if (editOrderId && editOrderData) {
                // Find and update existing order
                const orderIndex = orders.findIndex(o => o.id == editOrderId);
                if (orderIndex >= 0) {
                    // Preserve original data, update changed fields
                    orders[orderIndex] = {
                        ...orders[orderIndex],
                        product: productNames[selectedProductId] || 'CEM II/B-S 42,5N',
                        quantity: quantity,
                        unit: selectedUnit,
                        tons: tons.toFixed(1),
                        pricePerTon: pricePerTon,
                        priceNet: netPrice.toLocaleString('pl-PL', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' PLN',
                        priceVat: vat.toLocaleString('pl-PL', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' PLN',
                        priceTotal: total.toLocaleString('pl-PL', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' PLN',
                        deliveryDate: document.getElementById('delivery-date').value,
                        deliveryTime: document.getElementById('delivery-time').value,
                        transport: document.querySelector('.transport-card.selected .transport-name')?.textContent || 'Transport GEO',
                        location: document.getElementById('selected-location')?.textContent || 'Magazyn Centralny',
                        notes: document.getElementById('notes')?.value || '',
                        updatedAt: new Date().toISOString()
                    };
                    
                    localStorage.setItem('app:shared:orders', JSON.stringify(orders));
                    
                    // Update order number in success modal
                    const orderNumberEl = document.querySelector('.order-number');
                    if (orderNumberEl) {
                        orderNumberEl.textContent = 'Numer zamówienia: ' + orders[orderIndex].number;
                    }
                    
                    return orders[orderIndex];
                }
            }
            
            // Create new order
            const year = new Date().getFullYear();
            const randomNum = String(Math.floor(Math.random() * 9000) + 1000);
            const orderNumber = '#ZAM-' + year + '-' + randomNum;
            
            const order = {
                id: Date.now() + Math.random(),
                number: orderNumber,
                date: new Date().toISOString(),
                product: productNames[selectedProductId] || 'CEM II/B-S 42,5N',
                quantity: quantity,
                unit: selectedUnit,
                tons: tons.toFixed(1),
                pricePerTon: pricePerTon,
                priceNet: netPrice.toLocaleString('pl-PL', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' PLN',
                priceVat: vat.toLocaleString('pl-PL', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' PLN',
                priceTotal: total.toLocaleString('pl-PL', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' PLN',
                deliveryDate: document.getElementById('delivery-date').value,
                deliveryTime: document.getElementById('delivery-time').value,
                transport: document.querySelector('.transport-card.selected .transport-name')?.textContent || 'Transport GEO',
                location: document.getElementById('selected-location')?.textContent || 'Magazyn Centralny',
                status: 'Nowe',
                notes: document.getElementById('notes')?.value || '',
                createdAt: new Date().toISOString()
            };
            
            // Save new order to shared localStorage
            orders.unshift(order);
            localStorage.setItem('app:shared:orders', JSON.stringify(orders));
            
            // Create notification for the new order
            saveOrderNotification(order);
            
            // Update order number in success modal
            const orderNumberEl = document.querySelector('.order-number');
            if (orderNumberEl) {
                orderNumberEl.textContent = 'Numer zamówienia: ' + order.number;
            }
            
            return order;
        }
        
        // =====================================================
        // Save Order Notification to Shared Storage
        // =====================================================
        function saveOrderNotification(order) {
            const STORAGE_KEY = 'app:shared:notifications';
            
            try {
                const notifications = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                
                const notification = {
                    id: Date.now() + Math.random(),
                    kind: 'order_created',
                    title: `Zamówienie ${order.number} - Nowe zamówienie`,
                    desc: `${order.product} | ${order.quantity} ${order.unit === 'tons' ? 'ton' : order.unit === 'pallets' ? 'palet' : 'sam.'}`,
                    createdAt: new Date().toISOString(),
                    isUnread: true,
                    linkTab: 'zamowienia',
                    orderId: order.id,
                    orderNumber: order.number
                };
                
                notifications.unshift(notification);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(notifications));
            } catch (e) {
                console.error('Error saving notification:', e);
            }
        }

        function nextStep() {
            if (currentStep === totalSteps) {
                // Update summary before showing
                updateSummary();
                // Save order to shared localStorage
                saveOrderToStorage();
                
                // Update success modal text for edit mode
                if (editOrderId) {
                    document.getElementById('successModalTitle').textContent = 'Zamówienie zaktualizowane!';
                    document.getElementById('successModalText').innerHTML = 
                        'Zmiany w zamówieniu zostały zapisane pomyślnie.<br><br>' +
                        '<i class="fi fi-rr-check"></i> Dane zamówienia zaktualizowane';
                } else {
                    document.getElementById('successModalTitle').textContent = 'Zamówienie złożone!';
                    document.getElementById('successModalText').innerHTML = 
                        'Dziękujemy! Twoje zamówienie zostało pomyślnie przyjęte do realizacji.<br><br>' +
                        '<i class="fi fi-rr-envelope"></i> Potwierdzenie wysłane na email<br>' +
                        '<i class="fi fi-rr-mobile"></i> SMS wysłany do spedytora';
                }
                
                // Submit order - show success modal
                document.getElementById('successModal').classList.add('active');
            } else {
                currentStep++;
                if (currentStep === 4) {
                    updateSummary();
                }
                updateStepUI();
                window.scrollTo(0, 0);
            }
        }

        function updateSummary() {
            // Get current values
            const quantity = parseFloat(document.getElementById('quantity').value) || 0;
            const pricePerTon = productPrices[selectedProductId] || 410;
            
            // Convert to tons
            let tons = 0;
            let quantityText = '';
            
            if (selectedUnit === 'tons') {
                tons = quantity;
                quantityText = `${quantity} ton`;
            } else if (selectedUnit === 'pallets') {
                tons = quantity * CONVERSION_RATES.palletToTon;
                quantityText = `${quantity} palet (${tons.toFixed(1)} ton)`;
            } else if (selectedUnit === 'trucks') {
                tons = quantity * CONVERSION_RATES.truckToTon;
                const pallets = quantity * CONVERSION_RATES.truckToPallet;
                quantityText = `${quantity} samochodów (${pallets} palet, ${tons.toFixed(1)} ton)`;
            }
            
            // Get product name
            const productNames = {
                1: 'CEM I 42,5R',
                2: 'CEM II/B-S 42,5N',
                3: 'CEM II/A-S 42,5N'
            };
            const productName = productNames[selectedProductId] || 'CEM II/B-S 42,5N';
            
            // Calculate prices
            const netPrice = tons * pricePerTon;
            const vat = netPrice * 0.23;
            const total = netPrice + vat;
            
            // Update summary section
            const summaryProduct = document.querySelector('.summary-section:nth-child(2) .summary-value');
            if (summaryProduct) {
                summaryProduct.textContent = productName;
                const summaryDetails = summaryProduct.nextElementSibling;
                if (summaryDetails) {
                    summaryDetails.textContent = `Ilość: ${quantityText} | Cena: ${pricePerTon} PLN/tona | Wartość: ${netPrice.toLocaleString('pl-PL', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} PLN netto`;
                }
            }
            
            // Update price summary in step 4
            const summaryPriceNet = document.querySelector('#step-4 .price-summary .price-row:first-child span:last-child');
            const summaryPriceVat = document.querySelector('#step-4 .price-summary .price-row:nth-child(2) span:last-child');
            const summaryPriceTotal = document.querySelector('#step-4 .price-summary .price-row.total span:last-child');
            
            if (summaryPriceNet) {
                summaryPriceNet.textContent = netPrice.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' PLN';
            }
            if (summaryPriceVat) {
                summaryPriceVat.textContent = vat.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' PLN';
            }
            if (summaryPriceTotal) {
                summaryPriceTotal.textContent = total.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' PLN';
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepUI();
                window.scrollTo(0, 0);
            }
        }

        function selectLocation(id) {
            document.querySelectorAll('.location-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.location-card').classList.add('selected');
            
            // Update selected location in step 2
            const locationName = event.target.closest('.location-card').querySelector('.location-name').textContent.trim();
            const locationAddress = event.target.closest('.location-card').querySelector('.location-address').textContent.trim();
            const selectedLocationEl = document.getElementById('selected-location');
            if (selectedLocationEl) {
                selectedLocationEl.textContent = locationName.replace(/^[^\s]+\s/, '') + ' - ' + locationAddress;
            }
        }

        function openAddAddressModal() {
            document.getElementById('addAddressModal').classList.add('active');
        }

        function closeAddAddressModal() {
            document.getElementById('addAddressModal').classList.remove('active');
            document.getElementById('addAddressForm').reset();
        }

        function saveNewAddress(event) {
            event.preventDefault();

            const name = document.getElementById('address-name').value.trim();
            const street = document.getElementById('address-street').value.trim();
            const postal = document.getElementById('address-postal').value.trim();
            const city = document.getElementById('address-city').value.trim();
            const notes = document.getElementById('address-notes').value.trim();

            // Validation
            if (!name || !street || !postal || !city) {
                alert('Proszę wypełnić wszystkie wymagane pola (nazwa, ulica, kod pocztowy, miasto).');
                return;
            }

            const selectedProducts = Array.from(document.querySelectorAll('input[name="products"]:checked')).map(cb => cb.value);
            const productsText = selectedProducts.length > 0
                ? selectedProducts.join(', ') + ` (${selectedProducts.length} ${selectedProducts.length === 1 ? 'produkt' : 'produkty'})`
                : 'Brak produktów';

            // Save to localStorage
            const addressRecord = {
                name: name,
                street: street,
                postal: postal,
                city: city,
                notes: notes,
                products: selectedProducts,
                productsText: productsText,
                createdAt: new Date().toISOString()
            };
            const savedRecord = upsertRecord('addresses', addressRecord);

            // Re-render addresses from localStorage
            renderSavedAddresses();

            // Select the new location
            document.querySelectorAll('.location-card').forEach(card => {
                card.classList.remove('selected');
            });
            const newCard = document.querySelector(`.location-card[data-storage-id="${savedRecord.id}"]`);
            if (newCard) {
                newCard.classList.add('selected');
            }

            // Update selected location in step 2 if visible
            const selectedLocationEl = document.getElementById('selected-location');
            if (selectedLocationEl) {
                selectedLocationEl.textContent = name + ' - ' + street + ', ' + city;
            }

            // Close modal
            closeAddAddressModal();

            // Show success message
            alert('Nowy punkt odbioru został dodany pomyślnie!');
        }
        
        // Close modal on outside click
        document.getElementById('addAddressModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddAddressModal();
            }
        });

        // Product prices per ton
        const productPrices = {
            1: 400, // CEM I 42,5R
            2: 410, // CEM II/B-S 42,5N
            3: 420  // CEM II/A-S 42,5N
        };

        // Conversion rates
        const CONVERSION_RATES = {
            palletToTon: 1.458,  // 1 paleta = 1.458 ton
            truckToPallet: 17,   // 1 samochód = 17 palet
            truckToTon: 24.8     // 1 samochód = 24.8 ton
        };

        let selectedProductId = 2; // Default to CEM II/B-S
        let selectedUnit = 'pallets'; // Default unit

        function selectProduct(id) {
            document.querySelectorAll('.product-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.product-card').classList.add('selected');
            selectedProductId = id;
            updateQuantity(); // Recalculate prices with new product
        }

        function changeUnit(unit) {
            const quantityInput = document.getElementById('quantity');
            const quantitySlider = document.getElementById('quantity-slider');
            const currentValue = parseFloat(quantityInput.value) || 1;
            
            // Convert current value to tons first (using OLD selectedUnit)
            let currentTons = 0;
            if (selectedUnit === 'tons') {
                currentTons = currentValue;
            } else if (selectedUnit === 'pallets') {
                currentTons = currentValue * CONVERSION_RATES.palletToTon;
            } else if (selectedUnit === 'trucks') {
                currentTons = currentValue * CONVERSION_RATES.truckToTon;
            }
            
            // Now update selectedUnit to new value
            selectedUnit = unit;
            
            // Convert to new unit
            let newValue = 0;
            if (unit === 'tons') {
                newValue = Math.round(currentTons);
                quantityInput.max = 100;
                quantitySlider.max = 100;
            } else if (unit === 'pallets') {
                newValue = Math.round(currentTons / CONVERSION_RATES.palletToTon);
                quantityInput.max = 40;
                quantitySlider.max = 40;
            } else if (unit === 'trucks') {
                newValue = Math.round(currentTons / CONVERSION_RATES.truckToTon);
                quantityInput.max = 10;
                quantitySlider.max = 10;
            }
            
            quantityInput.value = newValue;
            quantitySlider.value = newValue;
            
            // Update label
            const labels = {
                'tons': 'Ilość ton:',
                'pallets': 'Ilość palet:',
                'trucks': 'Ilość samochodów:'
            };
            document.getElementById('quantity-label').textContent = labels[unit];
            
            updateQuantity();
        }

        function selectTransport(type) {
            document.querySelectorAll('.transport-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.transport-card').classList.add('selected');
        }

        function updateQuantity() {
            const quantity = parseFloat(document.getElementById('quantity').value) || 0;
            document.getElementById('quantity-slider').value = quantity;
            
            // Get selected product price
            const pricePerTon = productPrices[selectedProductId] || 410;
            
            // Convert quantity to tons based on selected unit
            let tons = 0;
            let conversionText = '';
            
            if (selectedUnit === 'tons') {
                tons = quantity;
                const pallets = (quantity / CONVERSION_RATES.palletToTon).toFixed(1);
                const trucks = (quantity / CONVERSION_RATES.truckToTon).toFixed(1);
                conversionText = `${quantity} ton ≈ ${pallets} palet ≈ ${trucks} samochodów`;
            } else if (selectedUnit === 'pallets') {
                tons = quantity * CONVERSION_RATES.palletToTon;
                const trucks = (quantity / CONVERSION_RATES.truckToPallet).toFixed(1);
                conversionText = `${quantity} palet ≈ ${tons.toFixed(1)} ton ≈ ${trucks} samochodów`;
            } else if (selectedUnit === 'trucks') {
                tons = quantity * CONVERSION_RATES.truckToTon;
                const pallets = quantity * CONVERSION_RATES.truckToPallet;
                conversionText = `${quantity} samochodów = ${pallets} palet ≈ ${tons.toFixed(1)} ton`;
            }
            
            // Calculate prices
            const netPrice = tons * pricePerTon;
            const vat = netPrice * 0.23;
            const total = netPrice + vat;
            
            // Update price display
            document.getElementById('price-net').textContent = netPrice.toLocaleString('pl-PL', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' PLN';
            document.getElementById('price-vat').textContent = vat.toLocaleString('pl-PL', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' PLN';
            document.getElementById('price-total').textContent = total.toLocaleString('pl-PL', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' PLN';
            
            // Update conversion hint
            document.getElementById('quantity-conversion').innerHTML = `<i class="fi fi-rr-lightbulb"></i> ${conversionText}`;
        }

        function updateQuantityFromSlider() {
            const quantity = document.getElementById('quantity-slider').value;
            document.getElementById('quantity').value = quantity;
            updateQuantity();
        }

        // Initialize on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved addresses from localStorage
            renderSavedAddresses();
            
            // Check if we're in edit mode
            checkEditMode();
            
            // Set current date as default for delivery date input
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${yyyy}-${mm}-${dd}`;
            document.getElementById('delivery-date').value = formattedDate;
            
            // Set current time as default
            const hh = String(today.getHours()).padStart(2, '0');
            const min = String(today.getMinutes()).padStart(2, '0');
            document.getElementById('delivery-time').value = `${hh}:${min}`;
        });

        // Initialize
        updateStepUI();

        // Select first location by default
        document.querySelector('.location-card').classList.add('selected');

        // Initialize quantity calculation
        updateQuantity();
    </script>
</body>
</html>